(()=>{"use strict";(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main");window.data={map:e,mainPin:t,LEFT_MOUSE_BUTTON:0,BUTTON_ENTER:"Enter",BUTTON_ESCAPE:"Escape"}})(),window.api={onLoad:(e,t,o)=>{let n;switch(e.status){case 200:case 201:t(e.response);break;case 400:n="Неверный запрос";break;case 401:n="Пользователь не авторизован";break;case 404:n="Запрашиваемый ресурс не найден";break;case 500:n="Внутренняя ошибка сервера";break;default:n="Cтатус ответа: : "+e.status+" "+e.statusText}n&&o(n)}},(()=>{const e=new XMLHttpRequest;e.responseType="json";const t=e=>{let t=document.createElement("div");t.style="z-index: 100; text-align: center; background-color: gold; position: absolute; left: 0; right: 0; top: 280px; font-size: 25px;",t.textContent=e,window.data.map.insertAdjacentElement("afterbegin",t)};e.open("GET","https://21.javascript.pages.academy/keksobooking/data"),e.send(),e.addEventListener("load",window.api.onLoad.bind(null,e,(e=>{window.download.advertisements=e}),t)),e.addEventListener("error",(()=>{t("Запрос не может быть выполнен, ошибка соединения")})),e.addEventListener("timeout",(()=>{t("Запрос не успел выполниться за "+e.timeout+"мс")})),e.timeout=5e3,window.download={advertisements:void 0,TIMEOUT:5e3}})(),window.pin={get:(e,t)=>{let o=document.querySelector("#pin").content.querySelector(".map__pin").cloneNode(!0);const n=o.querySelector("img");return o.style=`left: ${e.location.x-25}px; top: ${e.location.y-70}px`,o.dataset.id=t,n.src=e.author.avatar,n.alt=e.offer.title,o}},(()=>{const e={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"};window.card={get:t=>{let o=document.querySelector("#card").content.querySelector(".popup").cloneNode(!0);return o.querySelector(".popup__title").textContent=t.offer.title,o.querySelector(".popup__text--address").textContent=t.offer.address,o.querySelector(".popup__text--price").textContent=t.offer.price+"р/ночь",o.querySelector(".popup__type").textContent=e[t.offer.type],o.querySelector(".popup__text--capacity").textContent=`${t.offer.rooms} комнаты для ${t.offer.guests} гостей`,o.querySelector(".popup__text--time").textContent=`Заезд после ${t.offer.checkin}, выезд до ${t.offer.checkout}`,o.querySelector(".popup__description").textContent=t.offer.description,o.querySelector(".popup__avatar").src=t.author.avatar,((e,t)=>{const o=t.querySelectorAll(".popup__feature");let n=[];for(let t=0;t<o.length;t++){let r=n.length;for(;r<e.offer.features.length;r++)if(31===o[t].className.indexOf(e.offer.features[r])){n.push(o[t]);break}}o.forEach((e=>{n.includes(e)||e.remove()}))})(t,o),((e,t)=>{const o=t.querySelector(".popup__photos"),n=o.querySelector(".popup__photo");0===e.offer.photos.length?n.remove():n.src=e.offer.photos[0];const r=document.createDocumentFragment();e.offer.photos.forEach((e=>{let t=n.cloneNode();t.src=e,r.appendChild(t)})),o.appendChild(r)})(t,o),o}}})(),(()=>{const e={bungalow:"0",flat:"1000",house:"5000",palace:"10000"},t=document.querySelector(".ad-form"),o=t.querySelectorAll("fieldset"),n=t.querySelector("#address"),r=t.querySelector("#room_number"),a=t.querySelector("#capacity"),d=t.querySelector("#type"),i=t.querySelector("#price"),s=t.querySelector("#timein"),l=t.querySelector("#timeout"),c=t.querySelector(".ad-form__reset"),m=window.data.mainPin.offsetWidth,u=window.data.mainPin.offsetHeight,p=e=>{let t=e.getBoundingClientRect();return{top:t.top+pageYOffset,left:t.left+pageXOffset}},w=(e,t)=>{const o={minYCoord:130,maxYCoord:630,minXCoord:0,maxXCoord:window.data.map.offsetWidth};return t<o.minYCoord?t=o.minYCoord:t>o.maxYCoord&&(t=o.maxYCoord),e<o.minXCoord?e=o.minXCoord:e>o.maxXCoord&&(e=o.maxXCoord),{x:e,y:t}},f=()=>{"0"!==a.value&&"100"===r.value||"100"!==r.value&&"0"===a.value?a.setCustomValidity("не для гостей - 100 комнат"):a.value>r.value?a.setCustomValidity(`${r.value} комната/ы — для ${r.value} или меньше гостей`):a.setCustomValidity("")},y=()=>{i.min=e[d.value],i.placeholder=e[d.value]},v=e=>{s.value=e.target.value,l.value=e.target.value},g=()=>{window.data.map.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}));const e=window.data.map.querySelector(".map__card");e&&e.remove()},h=()=>{g(),window.mode.setPassive(),window.form.adForm.reset()};c.addEventListener("click",h),window.form={setNewAddress:e=>{const t=p(window.data.map);let o=p(window.data.mainPin),r=o.left-t.left,a=Math.floor(o.top+u+18),d=Math.floor(r+m/2),i=w(d,a);n.value=`${i.x}, ${i.y}`,e&&(a=Math.floor(o.top+u/2),i=w(d,a),n.value=`${i.x}, ${i.y}`)},verifyRoomsCapacity:f,verifyPriceForNight:y,setTimeInOut:v,adForm:t,adFieldsets:o,adAddress:n,adRoomNumber:r,adRoomCapacity:a,adTypeOfHousing:d,adPriceForNight:i,timeIn:s,timeOut:l,onChangeAdRoomCapacity:()=>{f()},onChangeAdTypeOfHousing:()=>{y()},onTimeChange:e=>{v(e)},onReset:h,getCoords:p,deletePinsAndCard:g}})(),(()=>{const e=window.data.map.querySelector(".map__filters"),t=e.querySelectorAll("select");let o;const n=[{name:"type",node:e.querySelector("#housing-type"),selected:!1},{name:"price",node:e.querySelector("#housing-price"),selected:!1},{name:"rooms",node:e.querySelector("#housing-rooms"),selected:!1},{name:"guests",node:e.querySelector("#housing-guests"),selected:!1},{name:"features",nodes:[e.querySelector("#filter-wifi"),e.querySelector("#filter-dishwasher"),e.querySelector("#filter-parking"),e.querySelector("#filter-washer"),e.querySelector("#filter-elevator"),e.querySelector("#filter-conditioner")],selected:!1}],r=(e,t)=>{let o=(e=>e.nodes.filter((e=>e.checked)))(e);return o.filter((e=>t.includes(e.value))).length===o.length},a=()=>{n.forEach((e=>{if("features"===e.name){for(let t=0;t<e.nodes.length;t++)if(e.nodes[t].checked){e.selected=!0;break}}else e.selected="any"!==e.node.value}));let e=n.filter((e=>e.selected)),t=window.download.advertisements;0!==e.length&&(t=((e,t)=>e.filter((e=>{for(let n=0;n<t.length;n++){let a,d=t[n],i="price"===d.name?(o=e.offer[d.name])<=1e4?"low":1e4<o&&o<5e4?"middle":"high":e.offer[d.name];switch(d.name){case"features":a=r(d,i);break;default:a=d.node.value===i.toString()}if(!a)return!1}var o;return!0})))(t,e)),window.form.deletePinsAndCard(),window.map.renderPinsList(t),window.filterForm.advertisements=t};e.addEventListener("change",(()=>{o&&clearTimeout(o),o=setTimeout(a,500)})),window.filterForm={selects:t}})(),(()=>{const e=window.data.map,t=e.querySelector(".map__pins"),o=t=>{t.key!==window.data.BUTTON_ESCAPE&&t.button!==window.data.LEFT_MOUSE_BUTTON||e.querySelector(".map__card ").remove()};window.map={renderPinsList:e=>{const o=document.createDocumentFragment();let n=e.length<5?e.length:5;for(let t=0;t<n;t++){let n=window.pin.get(e[t],t);o.appendChild(n)}t.appendChild(o)},renderCard:t=>{const n=window.card.get(t),r=n.querySelector(".popup__close");e.insertBefore(n,e.querySelector(".map__filters-container")),r.addEventListener("click",o),document.addEventListener("keydown",o)},pinsContainer:t,onSmallPinActivated:e=>{let o;if(e.key!==window.data.BUTTON_ENTER&&e.button!==window.data.LEFT_MOUSE_BUTTON)return;if("button"!==e.target.parentNode.type&&"button"!==e.target.type)return;const n=window.data.map.querySelector(".map__card ");n&&n.remove(),t.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.classList.remove("map__pin--active")})),e.target.dataset.id?(o=e.target.dataset.id,e.target.classList.add("map__pin--active")):(o=e.target.parentNode.dataset.id,e.target.parentNode.classList.add("map__pin--active"));let r=window.download.advertisements;window.filterForm.advertisements&&(r=window.filterForm.advertisements),window.map.renderCard(r[o])}}})(),(()=>{const e=window.map.pinsContainer,t=window.data.map,o=window.data.mainPin,n=t.offsetWidth,r=t.offsetHeight;let a,d={x:0,y:0};const i=(e,t)=>{e.forEach((e=>{e.disabled=t}))},s=()=>{a=!1,window.data.map.classList.add("map--faded"),window.form.adForm.classList.add("ad-form--disabled"),i(window.form.adFieldsets,!0),i(window.filterForm.selects,!0),o.style=`left: ${(n-o.offsetWidth)/2}px; top: ${r/2}px;`,window.form.setNewAddress(!0),o.addEventListener("click",w),o.addEventListener("keydown",w),o.addEventListener("mousedown",c)},l=()=>{a=!0,i(window.form.adFieldsets,!1),i(window.filterForm.selects,!1),window.data.map.classList.remove("map--faded"),window.form.adForm.classList.remove("ad-form--disabled"),window.map.renderPinsList(window.download.advertisements),window.form.adAddress.readOnly=!0,window.form.verifyRoomsCapacity(),window.form.verifyPriceForNight(),e.addEventListener("click",window.map.onSmallPinActivated),e.addEventListener("keydown",window.map.onSmallPinActivated),window.form.adTypeOfHousing.addEventListener("change",window.form.onChangeAdTypeOfHousing),window.form.adRoomNumber.addEventListener("change",window.form.onChangeAdRoomCapacity),window.form.adRoomCapacity.addEventListener("change",window.form.onChangeAdRoomCapacity),window.form.timeIn.addEventListener("change",window.form.onTimeChange),window.form.timeOut.addEventListener("change",window.form.onTimeChange)},c=e=>{d=m(e),window.map.pinsContainer.addEventListener("mousemove",u),window.map.pinsContainer.addEventListener("mouseup",p)},m=e=>({x:e.clientX,y:e.clientY}),u=e=>{e.preventDefault();let t=d.x-e.clientX,n=d.y-e.clientY;d={x:e.clientX,y:e.clientY},o.style.top=o.offsetTop-n+"px",o.style.left=o.offsetLeft-t+"px"},p=e=>{e.preventDefault(),window.form.setNewAddress(!1),window.map.pinsContainer.removeEventListener("mousemove",u),window.map.pinsContainer.removeEventListener("mouseup",p)},w=e=>{e.button!==window.data.LEFT_MOUSE_BUTTON&&e.key!==window.data.BUTTON_ENTER||(a||l(),o.removeEventListener("keydown",w),o.removeEventListener("click",w))};window.mode={setActive:l,setPassive:s},s()})(),(()=>{const e=document.querySelector("main");let t;const o=(e,n)=>{n.button!==window.data.LEFT_MOUSE_BUTTON&&n.key!==window.data.BUTTON_ESCAPE||(e.remove(),document.removeEventListener("keydown",o.bind(null,t)),document.removeEventListener("click",o.bind(null,t)))},n=()=>{window.form.onReset(),(()=>{const n=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);e.insertAdjacentElement("afterbegin",n),t=n,document.addEventListener("keydown",o.bind(null,t)),document.addEventListener("click",o.bind(null,t))})()},r=()=>{let n=document.querySelector("#error").content.querySelector(".error").cloneNode(!0);e.insertAdjacentElement("afterbegin",n),t=n,n.querySelector(".error__button").addEventListener("click",o.bind(null,t)),document.addEventListener("keydown",o.bind(null,t)),document.addEventListener("click",o.bind(null,t))};window.form.adForm.addEventListener("submit",(e=>{e.preventDefault();let t=new XMLHttpRequest;t.addEventListener("load",window.api.onLoad.bind(null,t,n,r)),t.addEventListener("error",(()=>{r()})),t.addEventListener("timeout",(()=>{r(t.timeout)})),t.timeout=window.download.TIMEOUT,t.open("POST","https://21.javascript.pages.academy/keksobooking"),t.send(new FormData(window.form.adForm))}))})()})();